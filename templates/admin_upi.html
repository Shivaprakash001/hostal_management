<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Admin - UPI Settings</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="stylesheet" href="/static/css/forms.css">
    <link rel="stylesheet" href="/static/css/responsive.css">
  </head>
  <body>
    <!-- Theme Toggle -->
    <button id="theme-toggle" class="theme-toggle">
      <i data-lucide="moon"></i>
    </button>

    <div class="admin-container">
      <div class="admin-header">
        <h1>UPI Settings Management</h1>
        <p class="admin-subtitle">Configure UPI details for receiving payments</p>
      </div>

      <!-- Current UPI Settings Display -->
      <div id="currentSettings" class="settings-card hidden">
        <div class="card-header">
          <h3>Current Active UPI Settings</h3>
        </div>
        <div class="card-body">
          <div class="settings-info">
            <div class="info-item">
              <span class="info-label">UPI ID:</span>
              <span class="info-value" id="currentUpiId"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Merchant Name:</span>
              <span class="info-value" id="currentMerchantName"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Status:</span>
              <span class="info-value status-active" id="currentStatus">Active</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Add New UPI Settings -->
      <div class="settings-card">
        <div class="card-header">
          <h3>Add New UPI Settings</h3>
        </div>
        <div class="card-body">
          <form id="upiForm" class="settings-form">
            <div class="form-group">
              <label for="upiId" class="form-label">UPI ID:</label>
              <input type="text" id="upiId" class="form-input" placeholder="e.g., admin@upi" required>
              <small class="form-help">Enter your UPI ID (e.g., yourname@upi)</small>
            </div>

            <div class="form-group">
              <label for="merchantName" class="form-label">Merchant Name:</label>
              <input type="text" id="merchantName" class="form-input" placeholder="e.g., Hostel Admin" required>
              <small class="form-help">Display name for the merchant</small>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <span class="btn-icon">ðŸ’¾</span>
                Save UPI Settings
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- All UPI Settings List -->
      <div class="settings-card">
        <div class="card-header">
          <h3>All UPI Settings</h3>
        </div>
        <div class="card-body">
          <div id="settingsList" class="settings-list">
            <div class="loading-indicator">
              <div class="loading-spinner"></div>
              <p>Loading UPI settings...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Error/Success Messages -->
      <div id="message" class="message hidden">
        <div class="message-content">
          <span id="messageIcon"></span>
          <span id="messageText"></span>
        </div>
      </div>
    </div>

    <script type="module">
      // Load current active UPI settings
      async function loadCurrentSettings() {
        try {
          const response = await fetch('/upi/active', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            document.getElementById('currentUpiId').textContent = data.upi_id;
            document.getElementById('currentMerchantName').textContent = data.merchant_name;
            document.getElementById('currentSettings').classList.remove('hidden');
          }
        } catch (err) {
          console.error('Error loading current settings:', err);
        }
      }

      // Load all UPI settings
      async function loadAllSettings() {
        const settingsList = document.getElementById('settingsList');

        try {
          const response = await fetch('/upi/', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const settings = await response.json();
            displaySettings(settings);
          } else {
            settingsList.innerHTML = '<p class="error-message">Failed to load UPI settings</p>';
          }
        } catch (err) {
          console.error('Error loading settings:', err);
          settingsList.innerHTML = '<p class="error-message">Error loading UPI settings</p>';
        }
      }

      // Display settings in a table
      function displaySettings(settings) {
        if (settings.length === 0) {
          document.getElementById('settingsList').innerHTML = '<p class="no-data">No UPI settings found</p>';
          return;
        }

        let html = `
          <table class="settings-table">
            <thead>
              <tr>
                <th>UPI ID</th>
                <th>Merchant Name</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        settings.forEach(setting => {
          const statusClass = setting.is_active ? 'status-active' : 'status-inactive';
          const statusText = setting.is_active ? 'Active' : 'Inactive';
          const activateBtn = setting.is_active ? '' : `<button class="btn btn-sm btn-success" onclick="activateSetting(${setting.id})">Activate</button>`;

          html += `
            <tr>
              <td>${setting.upi_id}</td>
              <td>${setting.merchant_name}</td>
              <td><span class="status ${statusClass}">${statusText}</span></td>
              <td>${new Date(setting.created_at).toLocaleDateString()}</td>
              <td>
                ${activateBtn}
                <button class="btn btn-sm btn-danger" onclick="deleteSetting(${setting.id})">Delete</button>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        document.getElementById('settingsList').innerHTML = html;
      }

      // Save new UPI settings
      document.getElementById('upiForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const upiId = document.getElementById('upiId').value.trim();
        const merchantName = document.getElementById('merchantName').value.trim();

        if (!upiId || !merchantName) {
          showMessage('Please fill in all fields', 'error');
          return;
        }

        try {
          const response = await fetch('/upi/', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              upi_id: upiId,
              merchant_name: merchantName
            })
          });

          if (response.ok) {
            showMessage('UPI settings saved successfully!', 'success');
            document.getElementById('upiForm').reset();
            loadCurrentSettings();
            loadAllSettings();
          } else {
            const error = await response.json();
            showMessage(error.detail || 'Failed to save UPI settings', 'error');
          }
        } catch (err) {
          console.error('Error saving settings:', err);
          showMessage('Error saving UPI settings', 'error');
        }
      });

      // Activate UPI setting
      async function activateSetting(id) {
        try {
          const response = await fetch(`/upi/${id}/activate`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            showMessage('UPI settings activated successfully!', 'success');
            loadCurrentSettings();
            loadAllSettings();
          } else {
            showMessage('Failed to activate UPI settings', 'error');
          }
        } catch (err) {
          console.error('Error activating settings:', err);
          showMessage('Error activating UPI settings', 'error');
        }
      }

      // Delete UPI setting
      async function deleteSetting(id) {
        if (!confirm('Are you sure you want to delete this UPI setting?')) {
          return;
        }

        try {
          const response = await fetch(`/upi/${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            showMessage('UPI settings deleted successfully!', 'success');
            loadCurrentSettings();
            loadAllSettings();
          } else {
            showMessage('Failed to delete UPI settings', 'error');
          }
        } catch (err) {
          console.error('Error deleting settings:', err);
          showMessage('Error deleting UPI settings', 'error');
        }
      }

      // Show message
      function showMessage(text, type) {
        const message = document.getElementById('message');
        const messageText = document.getElementById('messageText');
        const messageIcon = document.getElementById('messageIcon');

        messageText.textContent = text;
        messageIcon.textContent = type === 'success' ? 'âœ…' : 'âŒ';
        message.className = `message ${type}`;

        message.classList.remove('hidden');
        setTimeout(() => message.classList.add('hidden'), 5000);
      }

      // Load data on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadCurrentSettings();
        loadAllSettings();
      });

      // Theme toggle
      const toggleBtn = document.getElementById("theme-toggle");
      if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
          document.body.classList.toggle("dark");
          toggleBtn.innerHTML = document.body.classList.contains("dark")
            ? '<i data-lucide="sun"></i>'
            : '<i data-lucide="moon"></i>';
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        });
      }
    </script>
  </body>
</html>
